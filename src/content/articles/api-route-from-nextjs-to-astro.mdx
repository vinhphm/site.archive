---
date: 2023-03-08
title: 'API Route: From Next.js to Astro'
summary: I recently migrated Vinh.Dev from Next.js to Astro. Next.js is a cool and powerful framework for React, but Astro suits better for my personal/blogging website. The migration was not too hard. I was able to reuse some React components, but I had to change some features like Spotify‚Äôs current playing to work in Astro framework.
tags: [astro, spotify, api]
draft: false
---

Astro is a new kid on the block that lets you build websites faster than a rocket1. Unlike Next.js, which is a jack of all trades for React, Astro only cares about the client side and lets you use any frontend framework or none at all. Astro also has a cool feature called **Islands Architecture**, which allows you to ship less JavaScript by only hydrating the components that need interactivity. Astro is perfect for building websites that don‚Äôt need server-side functionality or a lot of bells and whistles. Sounds perfect for my Vinh.Dev site since I‚Äôm not building Facebook or Netflix üíÅ‚Äç‚ôÇÔ∏è

Here comes the problem. True as it said, Astro‚Äôs centric is client side so my Spotify current playing component need a bit of rework. If you don‚Äôt how what it is, here‚Äôs how it look on my [About page](/about):

<center>
  ![Spotify current playing](/static/images/2023/spotify-current-playing.png)
</center>

So here is how it used to work in Next.js version. On the site, I reserved an API route to handle all the Spotify API calls. The code for the API looks somewhat like this:

```typescript
// pages/api/playing.ts

import { getNowPlaying } from 'lib/spotify'

export default async function handler(_, res) {
  const response = await getNowPlaying()

  if (response.status === 204 || response.status > 400) {
    return res.status(200).json({ isPlaying: false })
  }

  const nowPlaying = await response.json()
  if (nowPlaying.currently_playing_type === 'track') {
    // song
    const isPlaying = nowPlaying.is_playing
    const title = nowPlaying.item.name
    const artist = nowPlaying.item.artists
      .map(_artist => _artist.name)
      .join(', ')
    const songUrl = nowPlaying.item.external_urls.spotify

    res.setHeader(
      'Cache-Control',
      'public, s-maxage=60, stale-while-revalidate=30'
    )
    return res.status(200).json({
      artist,
      isPlaying,
      songUrl,
      title,
    })
  } else if (nowPlaying.currently_playing_type === 'episode') {
    // podcast
    return res.status(200).json({
      isPlaying: nowPlaying.is_playing,
      songUrl: 'https://open.spotify.com',
      title: 'Podcast',
    })
  }
}
```

Things are a bit different in Astro though. Here is the same code but in Astro:

```typescript
// pages/api/playing.json.ts

import { getNowPlaying } from '@/lib/spotify'

export const get = async () => {
  const response = await getNowPlaying()

  if (response.status === 204 || response.status > 400) {
    return new Response(JSON.stringify({ isPlaying: false }), {
      status: 200,
    })
  }

  const nowPlaying = await response.json()
  if (nowPlaying.currently_playing_type === 'track') {
    // song
    const isPlaying = nowPlaying.is_playing
    const title = nowPlaying.item.name
    const artist = nowPlaying.item.artists
      .map((_artist: any) => _artist.name)
      .join(', ')
    const songUrl = nowPlaying.item.external_urls.spotify

    return new Response(
      JSON.stringify({
        artist,
        isPlaying,
        songUrl,
        title,
      }),
      {
        status: 200,
        headers: {
          'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=30',
        },
      }
    )
  } else if (nowPlaying.currently_playing_type === 'episode') {
    // podcast
    return new Response(
      JSON.stringify({
        isPlaying: nowPlaying.is_playing,
        songUrl: 'https://open.spotify.com',
        title: 'Podcast',
      }),
      {
        status: 200,
        headers: {
          'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=30',
        },
      }
    )
  }
}
```
