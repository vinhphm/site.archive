---
title: Embed Bluesky's and Other Services' Contents
date: 2024-11-10T18:00:00+07:00
lang: en
description: How to embed Bluesky's and other services' contents in your blog.
tag: Web
duration: 1 min read
draft: true
---
import OEmbed from '@/components/OEmbed.vue'

```javascript title="worker.js" showLineNumbers
// Cache for providers list
let providersCache = null;
let providersCacheTime = 0;
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

async function getProviders() {
  // Return cached providers if available and not expired
  if (providersCache && (Date.now() - providersCacheTime < CACHE_DURATION)) {
    return providersCache;
  }

  try {
    const response = await fetch('https://oembed.com/providers.json');
    if (!response.ok) {
      throw new Error(`Failed to fetch providers: ${response.status}`);
    }

    providersCache = await response.json();
    providersCacheTime = Date.now();
    return providersCache;
  } catch (error) {
    // If we have a cached version, use it even if expired
    if (providersCache) {
      return providersCache;
    }
    throw error;
  }
}

function findProvider(url, providers) {
  for (const provider of providers) {
    for (const endpoint of provider.endpoints) {
      for (const scheme of endpoint.schemes || []) {
        const pattern = new RegExp(
          '^' + scheme.replace(/\*/g, '.*').replace(/\?/g, '\\?') + '$'
        );
        if (pattern.test(url)) {
          return {
            name: provider.provider_name,
            endpoint: endpoint.url,
            formats: endpoint.formats || ['json'],
          };
        }
      }
      
      // If no schemes defined but url matches provider url
      if (!endpoint.schemes && url.startsWith(provider.provider_url)) {
        return {
          name: provider.provider_name,
          endpoint: endpoint.url,
          formats: endpoint.formats || ['json'],
        };
      }
    }
  }
  return null;
}

async function fetchOembedData(provider, targetUrl, options = {}) {
  const embedUrl = new URL(provider.endpoint);
  embedUrl.searchParams.set('url', targetUrl);
  
  // Set format preference (prefer json if available)
  const format = provider.formats.includes('json') ? 'json' : provider.formats[0];
  embedUrl.searchParams.set('format', format);
  
  // Add additional parameters if provided
  for (const [key, value] of Object.entries(options)) {
    if (value) {
      embedUrl.searchParams.set(key, value);
    }
  }

  const response = await fetch(embedUrl);
  
  if (!response.ok) {
    throw new Error(`Failed to fetch oEmbed data: ${response.status}`);
  }

  return response.json();
}

export default {
  async fetch(request, env, ctx) {
    // Handle CORS preflight requests
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
          'Access-Control-Max-Age': '86400',
        },
      });
    }

    // Parse URL and get parameters
    const url = new URL(request.url);
    const targetUrl = url.searchParams.get('url');

    if (!targetUrl) {
      return new Response('Missing URL parameter', {
        status: 400,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
      });
    }

    try {
      // Get providers list
      const providers = await getProviders();
      
      // Find the appropriate provider
      const provider = findProvider(targetUrl, providers);
      
      if (!provider) {
        return new Response(JSON.stringify({
          error: 'Unsupported URL format',
          message: 'No oEmbed provider found for this URL'
        }), {
          status: 400,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
        });
      }

      // Get additional options from query parameters
      const options = {};
      const validOptions = ['maxwidth', 'maxheight', 'theme', 'format', 'lang'];
      
      for (const option of validOptions) {
        const value = url.searchParams.get(option);
        if (value) {
          options[option] = value;
        }
      }

      const data = await fetchOembedData(provider, targetUrl, options);

      return new Response(JSON.stringify(data), {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
          'Cache-Control': 'public, max-age=3600',
          'X-Provider': provider.name,
        },
      });
    } catch (error) {
      console.error('Error:', error);
      
      return new Response(JSON.stringify({
        error: 'Error processing request',
        message: error.message
      }), {
        status: 500,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
      });
    }
  },
};
```

<OEmbed client:only="vue" url="https://bsky.app/profile/vinh.dev/post/3lalirzsyuc2i" />

<OEmbed client:only="vue" url="https://x.com/leeerob/status/1707443239630835805" />
